<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard - Payments</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h2{
      margin-bottom: 15px;
    }
    table{
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th{
      background: #333;
      color: white;
      padding: 10px;
      text-align: left;
    }
    td{
      border: 1px solid #ddd;
      padding: 8px;
    }
    tr:nth-child(even){
      background: #fafafa;
    }
    button{
      padding: 8px 12px;
      margin-bottom: 15px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <h2>Admin - Paiements RÃ©cents</h2>

  <button id="load">Charger les paiements</button>

  <table id="tbl">
    <thead>
      <tr>
        <th>Date</th>
        <th>User</th>
        <th>Invoice</th>
        <th>Status</th>
        <th>Fiat USD</th>
        <th>Crypto</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


  <script>
    async function loadPayments() {
      const headers = {};

      // Authentication admin
      if(localStorage.adminKey){
        headers['x-admin-key'] = localStorage.adminKey;
      }

      const res = await fetch('/api/admin/payments', { headers });

      // If admin key incorrect
      if(res.status === 401){
        const key = prompt("Admin key ?");
        if(!key) return;
        localStorage.adminKey = key;
        return loadPayments();
      }

      const data = await res.json();

      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML = '';

      data.forEach(p => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${new Date(p.createdAt).toLocaleString()}</td>
          <td>${p.userId?.email || "(inconnu)"}</td>
          <td>${p.invoiceId}</td>
          <td>${p.status}</td>
          <td>${(p.amount_usd_cents || 0) / 100}</td>
          <td>${p.crypto_currency || p.requested_currency || "N/A"}</td>
          <td><button onclick="showDetails('${p._id}')">Voir</button></td>
        `;

        tbody.appendChild(tr);
      });
    }

    function showDetails(id){
      alert("ID paiement : " + id);
    }

    document.getElementById('load').addEventListener('click', loadPayments);
  </script>

</body>
</html>